<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title><!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Title</title>
                    <style>
                        canvas {
                            background-color: white;
                        }

                        .mask_canvas {
                            position: absolute;
                            top: -50000px;
                            left: -50000px;
                        }

                        .next_canvas {
                            position: absolute;
                            top: -100000px;
                            left: -100000px;
                        }
                    </style>
                </head>
<body style="background-color: #000;text-align: center;padding:0 0 0 0; margin: 0 0 0 0">
<canvas id="canvas" width="800" height="600"></canvas>
<!--<canvas id="mask" class="mask_canvas" width="800" height="600"></canvas>
<canvas id="next" class="next_canvas" width="800" height="600"></canvas>-->
<!--<br>
<button id="step1">上一步</button>
<button id="step2">下一步</button>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script>
    $(function () {
        var data = {
            presentation: {
                slideSize: {
                    type: 'screen4x3',
                    cx: 9144000,
                    cy: 6858000
                }
            },
            slideIdList: [
                {
                    id: "257",
                    rid: "rId3",
                    target: "ppt/slides/slide2.xml"
                }
            ],
            slideList: {
                rId3: {
                    colorScheme: {
                        dk1: '#2F2B20',
                        dk2: '#675E47',
                        lt1: '#FFFFFF',
                        lt2: '#DFDCB7',
                        accent1: '#A9A57C',
                        accent2: '#9CBEBD',
                        accent3: '#D2CB6C',
                        accent4: '#95A39D',
                        accent5: '#C89F5D',
                        accent6: '#B1A089',
                        hlink: '#D25814',
                        folHlink: '#849A0A'
                    }
                    ,
                    colorMap: {
                        bg1: 'lt1',
                        bg2: 'lt2',
                        tx1: 'dk1',
                        tx2: 'dk2',
                        accent1: 'accent1',
                        accent2: 'accent2',
                        accent3: 'accent3',
                        accent4: 'accent4',
                        accent5: 'accent5',
                        accent6: 'accent6',
                        hlink: 'hlink',
                        folHlink: 'folHlink'
                    }
                    ,
                    "background": "#DFDCB7",
                    "shapes": [
                        {
                            "type": "shape",
                            "id": 2,
                            "name": "標題 1",
                            "spType": "title",
                            "x": 457200,
                            "y": 274638,
                            "cx": 7620000,
                            "cy": 1143000,
                            "presetGeom": "rect",
                            "textBody": {
                                "paragraphs": [
                                    {
                                        "lvl": 0,
                                        "defRPr": {
                                            "lang": "zh-TW",
                                            "sz": 4600,
                                            "kern": 1200,
                                            "cap": "none",
                                            "spc": -100,
                                            "baseline": 0,
                                            "solidFill": "#675E47",
                                            "latin": "+mj-lt",
                                            "ea": "+mj-ea",
                                            "cs": "+mj-cs"
                                        },
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "spcBef": 0,
                                        "buNone": true,
                                        "runs": [
                                            {
                                                "type": "r",
                                                "lang": "zh-TW",
                                                "sz": 4600,
                                                "kern": 1200,
                                                "cap": "none",
                                                "spc": -100,
                                                "baseline": 0,
                                                "solidFill": "#675E47",
                                                "latin": "+mj-lt",
                                                "ea": "+mj-ea",
                                                "cs": "+mj-cs",
                                                "kumimoji": 1,
                                                "altLang": "en-US",
                                                "dirty": 0,
                                                "smtClean": 0,
                                                "text": "簡報一"
                                            },
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    }
                                ],
                                "vert": "horz",
                                "lIns": 91440,
                                "tIns": 45720,
                                "rIns": 91440,
                                "bIns": 45720,
                                "rtlCol": 0,
                                "anchor": "ctr"
                            }
                        },
                        {
                            "type": "shape",
                            "id": 3,
                            "name": "內容版面配置區 2",
                            "spType": "body",
                            "x": 457200,
                            "y": 1600200,
                            "cx": 7620000,
                            "cy": 4800600,
                            "presetGeom": "rect",
                            "textBody": {
                                "paragraphs": [
                                    {
                                        "lvl": 0,
                                        "defRPr": {
                                            "lang": "zh-TW",
                                            "sz": 2200,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 342900,
                                        "indent": -228600,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "spcBef": 20000,
                                        "buClr": "#A9A57C",
                                        "buFont": "Arial",
                                        "buChar": "•",
                                        "runs": [
                                            {
                                                "type": "r",
                                                "lang": "zh-TW",
                                                "sz": 2200,
                                                "kern": 1200,
                                                "solidFill": "#2F2B20",
                                                "latin": "+mn-lt",
                                                "ea": "+mn-ea",
                                                "cs": "+mn-cs",
                                                "kumimoji": 1,
                                                "altLang": "en-US",
                                                "dirty": 0,
                                                "smtClean": 0,
                                                "text": "第一條"
                                            },
                                            {
                                                "type": "r",
                                                "lang": "en-US",
                                                "sz": 2200,
                                                "kern": 1200,
                                                "solidFill": "#2F2B20",
                                                "latin": "+mn-lt",
                                                "ea": "+mn-ea",
                                                "cs": "+mn-cs",
                                                "kumimoji": 1,
                                                "altLang": "zh-TW",
                                                "dirty": 0,
                                                "smtClean": 0
                                            },
                                            {
                                                "type": "br"
                                            },
                                            {
                                                "type": "r",
                                                "lang": "zh-TW",
                                                "sz": 2200,
                                                "kern": 1200,
                                                "solidFill": "#2F2B20",
                                                "latin": "+mn-lt",
                                                "ea": "+mn-ea",
                                                "cs": "+mn-cs",
                                                "kumimoji": 1,
                                                "altLang": "en-US",
                                                "dirty": 0,
                                                "smtClean": 0,
                                                "text": "測試測試"
                                            },
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    },
                                    {
                                        "lvl": 0,
                                        "defRPr": {
                                            "lang": "zh-TW",
                                            "sz": 2200,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 342900,
                                        "indent": -228600,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "spcBef": 20000,
                                        "buClr": "#A9A57C",
                                        "buFont": "Arial",
                                        "buChar": "•",
                                        "runs": [
                                            {
                                                "type": "r",
                                                "lang": "zh-TW",
                                                "sz": 2200,
                                                "kern": 1200,
                                                "solidFill": "#2F2B20",
                                                "latin": "+mn-lt",
                                                "ea": "+mn-ea",
                                                "cs": "+mn-cs",
                                                "kumimoji": 1,
                                                "altLang": "en-US",
                                                "dirty": 0,
                                                "smtClean": 0,
                                                "text": "第二條"
                                            },
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    },
                                    {
                                        "lvl": 2,
                                        "defRPr": {
                                            "lang": "zh-TW",
                                            "sz": 1800,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 1005840,
                                        "indent": -228600,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "spcBef": 20000,
                                        "buClr": "#D2CB6C",
                                        "buFont": "Arial",
                                        "buChar": "•",
                                        "runs": [
                                            {
                                                "type": "r",
                                                "lang": "zh-TW",
                                                "sz": 1800,
                                                "kern": 1200,
                                                "solidFill": "#2F2B20",
                                                "latin": "+mn-lt",
                                                "ea": "+mn-ea",
                                                "cs": "+mn-cs",
                                                "kumimoji": 1,
                                                "altLang": "en-US",
                                                "dirty": 0,
                                                "smtClean": 0,
                                                "text": "第三條"
                                            },
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    },
                                    {
                                        "lvl": 3,
                                        "defRPr": {
                                            "lang": "zh-TW",
                                            "sz": 1600,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 1280160,
                                        "indent": -228600,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "spcBef": 20000,
                                        "buClr": "#95A39D",
                                        "buFont": "Arial",
                                        "buChar": "•",
                                        "runs": [
                                            {
                                                "type": "r",
                                                "lang": "zh-TW",
                                                "sz": 1600,
                                                "kern": 1200,
                                                "solidFill": "#2F2B20",
                                                "latin": "+mn-lt",
                                                "ea": "+mn-ea",
                                                "cs": "+mn-cs",
                                                "kumimoji": 1,
                                                "altLang": "en-US",
                                                "dirty": 0,
                                                "smtClean": 0,
                                                "text": "第四條"
                                            },
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    }
                                ],
                                "vert": "horz",
                                "lIns": 91440,
                                "tIns": 45720,
                                "rIns": 91440,
                                "bIns": 45720,
                                "rtlCol": 0
                            }
                        },
                        {
                            "type": "shape",
                            "id": 7,
                            "name": "Rectangle 6",
                            "x": 8458200,
                            "y": 0,
                            "cx": 685800,
                            "cy": 6858000,
                            "presetGeom": "rect",
                            "solidFill": "#675E47",
                            "textBody": {
                                "paragraphs": [
                                    {
                                        "lvl": 0,
                                        "defRPr": {
                                            "lang": "en-US",
                                            "sz": 1800,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 0,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "runs": [
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    }
                                ],
                                "rtlCol": 0,
                                "anchor": "ctr"
                            }
                        },
                        {
                            "type": "shape",
                            "id": 8,
                            "name": "Rectangle 7",
                            "x": 8458200,
                            "y": 5486400,
                            "cx": 685800,
                            "cy": 685800,
                            "presetGeom": "rect",
                            "solidFill": "#A9A57C",
                            "textBody": {
                                "paragraphs": [
                                    {
                                        "lvl": 0,
                                        "defRPr": {
                                            "lang": "en-US",
                                            "sz": 1800,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 0,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "runs": [
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    }
                                ],
                                "rtlCol": 0,
                                "anchor": "ctr"
                            }
                        },
                        {
                            "type": "shape",
                            "id": 6,
                            "name": "Slide Number Placeholder 5",
                            "spType": "sldNum",
                            "x": 8531788,
                            "y": 5648960,
                            "cx": 548640,
                            "cy": 396240,
                            "presetGeom": "bracketPair",
                            "textBody": {
                                "paragraphs": [
                                    {
                                        "lvl": 0,
                                        "defRPr": {
                                            "lang": "en-US",
                                            "sz": 1800,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 0,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "runs": [
                                            {
                                                "type": "fld"
                                            },
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    }
                                ],
                                "vert": "horz",
                                "lIns": 0,
                                "tIns": 0,
                                "rIns": 0,
                                "bIns": 0,
                                "rtlCol": 0,
                                "anchor": "ctr"
                            }
                        },
                        {
                            "type": "shape",
                            "id": 5,
                            "name": "Footer Placeholder 4",
                            "spType": "ftr",
                            "rot": 16200000,
                            "x": 7586910,
                            "y": 4048760,
                            "cx": 2367281,
                            "cy": 365760,
                            "presetGeom": "rect",
                            "textBody": {
                                "paragraphs": [
                                    {
                                        "lvl": 0,
                                        "defRPr": {
                                            "lang": "en-US",
                                            "sz": 1800,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 0,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "runs": [
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    }
                                ],
                                "vert": "horz",
                                "lIns": 91440,
                                "tIns": 45720,
                                "rIns": 91440,
                                "bIns": 45720,
                                "rtlCol": 0,
                                "anchor": "ctr"
                            }
                        },
                        {
                            "type": "shape",
                            "id": 4,
                            "name": "Date Placeholder 3",
                            "spType": "dt",
                            "rot": 16200000,
                            "x": 7551351,
                            "y": 1645920,
                            "cx": 2438399,
                            "cy": 365760,
                            "presetGeom": "rect",
                            "textBody": {
                                "paragraphs": [
                                    {
                                        "lvl": 0,
                                        "defRPr": {
                                            "lang": "en-US",
                                            "sz": 1800,
                                            "kern": 1200,
                                            "solidFill": "#2F2B20",
                                            "latin": "+mn-lt",
                                            "ea": "+mn-ea",
                                            "cs": "+mn-cs"
                                        },
                                        "marL": 0,
                                        "algn": "l",
                                        "defTabSz": 914400,
                                        "rtl": false,
                                        "eaLnBrk": true,
                                        "latinLnBrk": false,
                                        "hangingPunct": 1,
                                        "runs": [
                                            {
                                                "type": "fld"
                                            },
                                            {
                                                "type": "end"
                                            }
                                        ]
                                    }
                                ],
                                "vert": "horz",
                                "lIns": 91440,
                                "tIns": 45720,
                                "rIns": 91440,
                                "bIns": 45720,
                                "rtlCol": 0,
                                "anchor": "ctr"
                            }
                        },
                        {
                            "type": "pic",
                            "id": 9,
                            "name": "圖片 8",
                            "descr": "image6.png",
                            "rotWithShape": true,
                            "blip": {
                                "embed": "ppt/media/image2.png",
                                "srcRect": {
                                    "l": 5681,
                                    "t": 34663,
                                    "r": 6586,
                                    "b": 32076
                                }
                            },
                            "x": 6145327,
                            "y": 6200380,
                            "cx": 2312871,
                            "cy": 657618,
                            "presetGeom": "rect"
                        }
                    ]
                }
            }
        };
        var canvas = $('#canvas')[0];

        /*var slideStep = {
         slide: 0,
         step: 0,
         slideLength: 0,
         stepLength: 0,
         steps: []
         };*/

        var presentationData = {};

        var canvasData = {};

        presentationInit(data);

        /*$('#step1').click(function () {
         });

         $('#step2').click(function () {
         });*/

        function canvasInit() {
            var vzw = document.documentElement.clientWidth;
            var vzh = document.documentElement.clientHeight;
            var _canvasd = calculateCanvasWidth(vzw, vzh);
            var canvas = $('#canvas')[0];
            //var mask = $('#mask')[0];
            //var next = $('#next')[0];

            canvasData.cw = _canvasd.w;
            canvasData.ch = _canvasd.h;
            canvasData.canvas = {
                width: _canvasd.w,
                height: _canvasd.h
            };

            canvas.width = _canvasd.w;
            canvas.height = _canvasd.h;

            canvasData.mask = {
                width: _canvasd.w,
                height: _canvasd.h
            };
            //mask.width = _canvasd.w;
            //mask.height = _canvasd.h;

            canvasData.next = {
                width: _canvasd.w,
                height: _canvasd.h
            }
            //next.width = _canvasd.w;
            //next.height = _canvasd.h;
        }

        function presentationInit(data) {
            canvasInit();

            presentationData.cw = parseInt(data.presentation.slideSize.cx, 10);
            presentationData.ch = parseInt(data.presentation.slideSize.cy, 10);
            /*slideStep.slide = 0;
             slideStep.slideLength = data.slideIdList.length;*/
            slideInit(data, 0);
        }

        function slideInit(data, idx) {
            /*slideData.step  = 0;
             slideData.slide = idx;
             timingInit(data, idx);*/
            drawSlide(data, 'rId3', $('#canvas')[0]);
        }

        function timingInit(data, idx) {
            /*var timing = data.slideList[data.slideIdList[idx].rid].timing;
             var steps = steBuilder(timing);
             steps.reduce(function(pre, cur) {
             var step = {};
             var start = '';
             }, []);*/
        }

        function stepBuilder(timing) {
            /*var root = timing.timeNodeList.parallel;
             var seq = root.childTimeNodeList.sequence.parallel;
             var steps = seq.reduce(function(pre, cur) {
             var start = cur;
             while(start.startConditionList.filter(function(cond) {if(cond.delay === 'indefinite') {return false} else {return true}}).length === 0) {
             start = start.childTimeNodeList.parallel[0];
             }
             pre.push(start);
             return pre;
             }, []);
             return steps;*/
        }

        function drawSlide(data, idx, canvas) {
            var slide = data.slideList[idx];
            if (!!slide.transition) {
                var mask = $('#mask')[0];
                var next = $('#next')[0];
                var ctx_canvas = canvas.getContext('2d');
                var ctx_mask = mask.getContext('2d');
                var ctx_next = next.getContext('2d');
                ctx_next.fillStyle = slide.background;
                ctx_next.fillRect(0, 0, next.width, next.height);
                ctx_mask.fillStyle = slide.background;
                ctx_mask.fillRect(0, 0, mask.width, mask.height);
                slide.shapes.forEach(function (shape, idx) {
                    if (shape.type === 'shape') {
                        drawShape(slide, idx, ctx_next);
                    }
                    if (shape.type === 'pic') {
                        drawPic(slide, idx, ctx_next);
                    }
                });
                drawTransition(slide.transition, ctx_canvas, ctx_next, ctx_mask);
            } else {
                var ctx = canvas.getContext('2d');
                ctx.fillStyle = slide.background;
                ctx.fillRect(0, 0, canvasData.cw, canvasData.ch);
                slide.shapes.forEach(function (shape, idx) {
                    if (shape.type === 'shape') {
                        drawShape(slide, idx, ctx);
                    }
                    if (shape.type === 'pic') {
                        drawPic(slide, idx, ctx);
                    }
                });
            }
        }

        function drawShape(slide, idx, ctx) {
            var canvasw = canvasData.cw;
            var shape = slide.shapes[idx];
            if (!!shape.solidFill) {
                ctx.fillStyle = shape.solidFill;
                ctx.fillRect(
                    emu2pixel(shape.x, presentationData.cw, canvasw),
                    emu2pixel(shape.y, presentationData.cw, canvasw),
                    emu2pixel(shape.cx, presentationData.cw, canvasw),
                    emu2pixel(shape.cy, presentationData.cw, canvasw)
                );
            }
            /*ctx.strokeStyle = '#7799BB';
            ctx.strokeRect(
                emu2pixel(shape.x, presentationData.cw, canvasw),
                emu2pixel(shape.y, presentationData.cw, canvasw),
                emu2pixel(shape.cx, presentationData.cw, canvasw),
                emu2pixel(shape.cy, presentationData.cw, canvasw)
            );*/
            if (!!shape.textBody && !!shape.textBody.paragraphs && Array.isArray(shape.textBody.paragraphs) && shape.textBody.paragraphs.length > 0) {
                drawTextblock(shape.textBody);
            }

            function drawTextblock(block) {
                var x = shape.x + block.lIns, y = shape.y + block.tIns;
                var cx = shape.x + shape.cx - block.rIns, cy = shape.y + shape.cy - block.bIns;
                var lh = block.paragraphs.reduce(function(pre, cur) {
                    var max = cur.runs
                        .filter(function(x) {return x.type === 'r'})
                        .reduce(function(pre1, cur1) {
                            if(cur1.type === 'r' && cur1.sz > pre1) {
                                return cur1.sz;
                            } else {
                                return pre1;
                            }
                        }, pre);
                    if(max > pre) {
                        return max;
                    } else {
                        return pre;
                    }
                }, 0);
                var lineHeight = Math.round(pixel2emu(pt2pixel(lh, presentationData.cw, canvasData.cw) * 1.2, presentationData.cw, canvasData.cw));

                var linenum = 1;
                block.paragraphs.forEach(function (paragraph, index) {
                    var textOffX = x + (!!paragraph.marL?paragraph.marL:0) + (!!paragraph.indent?paragraph.indent:0);
                    var buOffX = 0;
                    if(!!paragraph.runs) {
                        if(!!paragraph.buFont && !!paragraph.buChar && !!paragraph.buClr) {
                            buOffX = drawText(ctx, textOffX, y + lineHeight * linenum, paragraph.buFont, paragraph.buClr, paragraph.defRPr.sz, paragraph.buChar+' ');
                            textOffX += buOffX + paragraph.spcBef;
                            //textOffX = x + paragraph.marL + paragraph.indent + paragraph.spcBef;
                        }
                        paragraph.runs.forEach(function(run) {
                            if(run.type === 'r' && !!run.text) {
                                for(var i=0; i<run.text.length; i++) {
                                    ctx.font = !!run.b?'900 ':'' + !!run.i?'italic ':'' + pt2pixel(run.size, presentationData.cw, canvasData.cw) + 'px ' + run.face;
                                    if(pixel2emu(ctx.measureText(run.text[i]).width, presentationData.cw, canvasData.cw)+textOffX > cx) {
                                        linenum++;
                                        textOffX = x + paragraph.marL + paragraph.indent + buOffX + paragraph.spcBef;
                                    }
                                    textOffX += drawText(ctx, textOffX, y + lineHeight * linenum, run.face, (!!run.solidFill?run.solidFill:'tx1'), run.sz, run.text[i], run.b, run.i);
                                }
                            }
                            if(run.type === 'br') {
                                linenum++;
                                textOffX = x + paragraph.marL + paragraph.indent + buOffX + paragraph.spcBef;
                            }
                        });
                    }
                    linenum++;
                });
                function drawText(ctx, hpos, vpos, font, color, size, str, b, i) {
                    ctx.font = (!!b? ' 900 ':'') + (!!i?' italic ':'') + pt2pixel(size, presentationData.cw, canvasData.cw) + 'px ' + font;
                    //console.log('[drawText]', color);
                    ctx.fillStyle = color;
                    ctx.textBaseline = 'ideographic';
                    ctx.fillText(str, emu2pixel(hpos, presentationData.cw, canvasData.cw), emu2pixel(vpos, presentationData.cw, canvasData.cw));
                    return pixel2emu(ctx.measureText(str).width, presentationData.cw, canvasData.cw);
                }
            }
        }

        function drawPic(slide, idx, ctx) {
            var canvasw = canvasData.canvas.width;
            var pic = slide.shapes[idx];
            var img = new Image();
            img.src = pic.blip.embed;
            img.onload = function () {
                var picx = img.width, picy = img.height;
                var l = pic.blip.srcRect.l / 100000, r = pic.blip.srcRect.r / 100000, t = pic.blip.srcRect.t / 100000, b = pic.blip.srcRect.b / 100000;
                var offx = pic.x, offy = pic.y;
                var cx = pic.cx, cy = pic.cy;

                var sx = Math.round(picx * l), sy = Math.round(picy * t);
                var sw = Math.round(picx - picx * (l + r)), sh = Math.round(picy - picy * (t + b));
                var dx = emu2pixel(offx, presentationData.cw, canvasw), dy = emu2pixel(offy, presentationData.cw, canvasw);
                var dw = emu2pixel(cx, presentationData.cw, canvasw), dh = emu2pixel(cy, presentationData.cw, canvasw);
                ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
            }
        }

        function drawTransition(transition, target, next, mask) {
            var start = null;
            requestAnimationFrame(transitionAnimate);
            function transitionAnimate(t) {
                if (start === null) {
                    start = t;
                    requestAnimationFrame(transitionAnimate);
                } else {
                    var progress = (t - start) / transition.duration;
                    mask.fillStyle = '#FFFFFF';
                    mask.fillRect(0, 0, canvasData.canvas.width, canvasData.canvas.height);
                    drawTransitionPattern(transition, mask, progress);
                    var x = 0, y = 0;
                    var maskImg = mask.getImageData(0, 0, canvasData.cw, canvasData.ch);
                    var nextImg = next.getImageData(0, 0, canvasData.cw, canvasData.ch);
                    var targetImg = target.getImageData(0, 0, canvasData.cw, canvasData.ch);
                    var output = target.createImageData(targetImg);
                    for (var i = 0; i < targetImg.data.length; i += 4) {
                        if (maskImg.data[i] == 0 && maskImg.data[i + 1] == 0 && maskImg.data[i + 2] == 0) {
                            output.data[i] = nextImg.data[i];
                            output.data[i + 1] = nextImg.data[i + 1];
                            output.data[i + 2] = nextImg.data[i + 2];
                            output.data[i + 3] = 255;
                        } else {
                            output.data[i] = targetImg.data[i];
                            output.data[i + 1] = targetImg.data[i + 1];
                            output.data[i + 2] = targetImg.data[i + 2];
                            output.data[i + 3] = 255;
                        }
                    }
                    target.putImageData(output, 0, 0);
                    if (t - start < transition.duration) {
                        requestAnimationFrame(transitionAnimate);
                    }
                }
            }
        }

        function drawTransitionPattern(transition, mask, progress) {
            switch (transition.type) {
                case 'comb':
                    var num = 8;
                    var start = 0;
                    var side = 0;
                    if (transition.dir === 'horz') {
                        var bh = Math.round(canvasData.ch / num);
                        while (start < canvasData.ch) {
                            mask.fillStyle = '#000000';
                            if (side % 2 === 0) {
                                mask.fillRect(0, start, Math.round(progress * canvasData.cw), bh);
                            } else {
                                var l = Math.round(canvasData.cw * (1 - progress));
                                mask.fillRect(Math.round(canvasData.cw * (1 - progress)), start, canvasData.cw - l, bh);
                            }
                            start += bh;
                            side++;
                        }
                    } else {
                        var bw = Math.round(canvasData.cw / num);
                        while (start < canvasData.cw) {
                            mask.fillStyle = '#000000';
                            if (side % 2 === 0) {
                                mask.fillRect(start, 0, bw, Math.round(progress * canvasData.ch));
                            } else {
                                var t = Math.round(canvasData.ch * (1 - progress));
                                mask.fillRect(start, Math.round(canvasData.ch * (1 - progress)), bw, canvasData.ch - t);
                            }
                            start += bw;
                            side++;
                        }
                    }
                    break;
            }
        }

        function pt2pixel(sz, screenw, canvasw) {
            return Math.round(sz * 914400 * canvasw / 100 / 72 / screenw);
        }

        function emu2pixel(l, screenw, canvasw) {
            return Math.round(l * canvasw / screenw);
        }

        function pixel2emu(l, screenw, canvasw) {
            return Math.round(l * screenw / canvasw);
        }

        function calculateCanvasWidth(vzw, vzh) {
            if (vzh / 3 * 4 < vzw) {
                return {w: Math.round((vzh - 20) * 4 / 3), h: vzh - 20};
            } else {
                return {w: vzw - Math.round(20 * 4 / 3), h: Math.round(vzw * 3 / 4) - 20};
            }
        }

        function define_quadratic_bezier(x0, y0, x1, y1, x2, y2) {
            return function (t) {
                if (t < 0 || t > 1) throw "[define_quadratic_bezier] t must between 0 and 1.";
                var px = Math.pow(1 - t, 2) * x0 + 2 * t * (1 - t) * x1 + Math.pow(t, 2) * x2;
                var py = Math.pow(1 - t, 2) * y0 + 2 * t * (1 - t) * y1 + Math.pow(t, 2) * y2;
                return [px, py];
            };
        }

        //this easing is from jquery's swing
        function easing(p) {
            return 0.5 - Math.cos(p * Math.PI) / 2;
        }
    });
</script>
</body>
</html></title>
</head>
<body>

</body>
</html></title>
</head>
<body>

</body>
</html>